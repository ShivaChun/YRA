<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>自地自建評估計算書</title>

    <!-- 1. 引入 Babel (用於瀏覽器端編譯 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 2. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['GenYoGothic', 'sans-serif'],
            },
            cursor: {
              grab: 'grab',
              grabbing: 'grabbing',
            }
          },
        },
      }
    </script>

    <style>
      @font-face {
        font-family: 'GenYoGothic';
        src: local('GenYoGothic'), local('源樣黑體'), local('Noto Sans TC');
      }
      body {
        background-color: #f5f5f4;
        font-family: 'GenYoGothic', sans-serif;
        overflow-x: hidden;
        overscroll-behavior-y: none; 
      }
      .num-font {
        font-variant-numeric: tabular-nums;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      @keyframes riseUp {
        0% { transform: translate3d(var(--tx), var(--ty), -50px); opacity: 0; }
        100% { transform: translate3d(var(--tx), var(--ty), var(--tz)); opacity: 1; }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- 注意：使用 type="text/babel" data-type="module" -->
    <script type="text/babel" data-type="module">
      import React, { useState, useMemo, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
      import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
      import { 
        MapPin, Ruler, FileText, Info, Building2, Car, Layers, 
        ArrowDownUp, AlertTriangle, Bike, Compass, Plus, Trash2, 
        ChevronDown, ChevronUp, ChevronRight, ChevronLeft, Map, LayoutDashboard, Settings2, 
        Pencil, RefreshCw, RotateCw, Eye, Maximize, ToggleLeft, 
        ToggleRight, Box, Sun, Moon, ZoomIn, ZoomOut, PanelRightClose, PanelRightOpen 
      } from 'https://esm.sh/lucide-react@0.263.1';

      // --- Helper Functions ---
      const formatNum = (num) => {
        return new Intl.NumberFormat('zh-TW', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(num || 0);
      };

      const toSqm = (ping) => ping * 3.3058;
      const toPing = (sqm) => sqm * 0.3025;

      // --- Components ---

      const ArtisticCompass = ({ className, rotation, isDarkMode }) => (
        <div className={`${className} relative flex items-center justify-center opacity-80 transition-transform duration-300 ease-out`} style={{ transform: `rotate(${rotation}deg)` }}>
          <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-lg">
            <circle cx="50" cy="50" r="46" fill={isDarkMode ? "#1e293b" : "#f8fafc"} stroke={isDarkMode ? "#475569" : "#94a3b8"} strokeWidth="1.5" />
            <circle cx="50" cy="50" r="42" fill="none" stroke={isDarkMode ? "#64748b" : "#cbd5e1"} strokeWidth="0.5" strokeDasharray="3 3" />
            <line x1="50" y1="4" x2="50" y2="96" stroke={isDarkMode ? "#334155" : "#e2e8f0"} strokeWidth="0.5" />
            <line x1="4" y1="50" x2="96" y2="50" stroke={isDarkMode ? "#334155" : "#e2e8f0"} strokeWidth="0.5" />
            <path d="M 50 10 L 55 50 L 50 50 L 45 50 Z" fill="#ef4444" />
            <text x="50" y="24" textAnchor="middle" fontSize="8" fontWeight="bold" fill={isDarkMode ? "#e2e8f0" : "#334155"} className="font-serif">N</text>
            <circle cx="50" cy="50" r="2" fill={isDarkMode ? "#e2e8f0" : "#475569"} />
          </svg>
        </div>
      );

      const SummaryRow = ({ label, value, isAlert, alertText, highlight, subtext, colorClass }) => (
        <div className={`flex justify-between items-center ${highlight ? 'bg-amber-50 p-2 rounded -mx-2' : ''}`}>
          <span className="text-stone-500 text-sm font-medium">{label}</span>
          <div className="text-right">
            <span className={`text-sm font-bold num-font ${colorClass ? colorClass : 'text-stone-800'}`}>
              {typeof value === 'number' ? formatNum(value) : value || '-'}
            </span>
            {subtext && <span className="ml-1 text-xs text-stone-400 font-normal">{subtext}</span>}
            {isAlert && <span className="ml-2 text-[10px] bg-rose-100 text-rose-600 px-1 rounded font-bold">{alertText}</span>}
          </div>
        </div>
      );

      const InfoItem = ({label:e,value:t,unit:n,isDarkMode:r}) => (
        <div className="flex flex-col flex-shrink-0 min-w-fit">
          <span className={`${r?"text-slate-400":"text-stone-400"} text-[10px]`}>{e}</span>
          <span className={`font-bold text-sm whitespace-nowrap ${r?"text-slate-100":"text-stone-700"}`}>{t} {n}</span>
        </div>
      );

      const LegendItem = ({color:e,label:t,value:n,type:r="box",textColor:l="text-stone-600",valueColor:o="text-stone-400"}) => (
        <div className="flex items-center gap-2 flex-shrink-0">
          {r==="box"?<div className={`w-3 h-3 rounded-full border ${e}`}></div>:<div className={`w-4 h-[2px] ${e}`}></div>}
          <div className="flex gap-1">
            <span className={`font-bold text-xs ${l}`}>{t}</span>
            {n&&<span className={`text-xs ${o}`}>{n}</span>}
          </div>
        </div>
      );

      const BuildingLayer = ({ width, depth, height, x, y, z, color, strokeColor, opacity, visible, showFrame, isSlabMode, animate, delay, isDarkMode }) => {
        if (!visible) return null;
        const thickness = isSlabMode ? Math.max(1.5, height * 0.08) : height;
        
        const transform = `translate3d(${x}px, ${y}px, ${z}px)`;
        
        const face = (w, h, tx, ty, tz, rx, ry, rz, bg, border, op) => ({
          width: `${w}px`, height: `${h}px`,
          position: 'absolute', left: '50%', top: '50%',
          marginLeft: `-${w / 2}px`, marginTop: `-${h / 2}px`,
          backgroundColor: bg, border: border, boxSizing: 'border-box',
          transform: `translate3d(${tx}px, ${ty}px, ${tz}px) rotateX(${rx}deg) rotateY(${ry}deg) rotateZ(${rz}deg)`,
          opacity: op, pointerEvents: 'none', transition: 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)',
          backfaceVisibility: 'visible',
          boxShadow: isDarkMode ? (isSlabMode ? "inset 0 0 15px rgba(255,255,255,0.1)" : "none") : (isSlabMode ? "inset 0 0 5px rgba(0,0,0,0.1)" : "none")
        });

        const borderStyle = showFrame ? `1px solid ${strokeColor}` : 'none';
        const finalBorder = isSlabMode ? `1px solid ${strokeColor}` : borderStyle;
        const finalOpacity = isSlabMode ? (isDarkMode ? 0.95 : 0.95) : opacity;

        return (
          <div className="absolute" style={{
            left: '50%', top: '50%', width: 0, height: 0, transformStyle: 'preserve-3d', transform,
            animation: animate ? `riseUp 0.8s ease-out ${delay}ms backwards` : 'none',
            '--tx': `${x}px`, '--ty': `${y}px`, '--tz': `${z}px`
          }}>
            <div style={face(width, thickness, 0, depth/2, thickness/2, 90, 0, 0, color, finalBorder, finalOpacity)} />
            <div style={face(width, thickness, 0, -depth/2, thickness/2, -90, 0, 0, color, finalBorder, finalOpacity)} />
            <div style={face(depth, thickness, width/2, 0, thickness/2, 0, 90, 90, color, finalBorder, finalOpacity)} />
            <div style={face(depth, thickness, -width/2, 0, thickness/2, 0, 90, -90, color, finalBorder, finalOpacity)} />
            <div style={face(width, depth, 0, 0, thickness, 0, 0, 0, color, finalBorder, finalOpacity + 0.1)} />
            <div style={face(width, depth, 0, 0, 0, 0, 0, 0, color, finalBorder, finalOpacity)} />
          </div>
        );
      };

      const Visualizer3D = ({ inputs, res, onUpdateBaseDim }) => {
        const [animate, setAnimate] = useState(false);
        const [showCheckLines, setShowCheckLines] = useState(false);
        const [showWeiLao, setShowWeiLao] = useState(false); 
        const [isDarkMode, setIsDarkMode] = useState(false);
        
        const [rotationZ, setRotationZ] = useState(-45);
        const [viewAngleX, setViewAngleX] = useState(58);
        const [zoom, setZoom] = useState(1);
        const [isDragging, setIsDragging] = useState(false);
        
        // Touch State
        const lastMousePos = useRef({ x: 0, y: 0 });
        const lastPinchDist = useRef(null); // Track pinch distance
        
        const viewportRef = useRef(null);

        const [isMobile, setIsMobile] = useState(false);
        const [isSummaryOpen, setIsSummaryOpen] = useState(true);

        const floorsBelow = Math.max(0, parseInt(inputs.floorsBelow) || 0);

        // 新增：判斷是否為手機橫向全螢幕模式
        const isLandscapeMode = isMobile && !isSummaryOpen;

        useEffect(() => {
          const checkMobile = () => setIsMobile(window.innerWidth < 768);
          checkMobile();
          window.addEventListener('resize', checkMobile);
          return () => window.removeEventListener('resize', checkMobile);
        }, []);

        useEffect(() => {
          setAnimate(true);
          const timer = setTimeout(() => setAnimate(false), 1000);
          return () => clearTimeout(timer);
        }, [res.floorsAbove]);

        useEffect(() => {
          const element = viewportRef.current;
          if (!element) return;

          const handleNativeWheel = (e) => {
            if(e.cancelable) {
                e.preventDefault();
            }
            e.stopPropagation();

            const sensitivity = 0.002;
            const delta = -e.deltaY * sensitivity;
            setZoom(prev => Math.min(3, Math.max(0.2, prev + delta)));
          };

          // Native wheel listener for smooth desktop zoom without page scroll
          element.addEventListener('wheel', handleNativeWheel, { passive: false });

          return () => {
            element.removeEventListener('wheel', handleNativeWheel);
          };
        }, []); 

        // Helper: Calculate distance between two touch points
        const getTouchDistance = (touches) => {
            return Math.hypot(
                touches[0].pageX - touches[1].pageX,
                touches[0].pageY - touches[1].pageY
            );
        };

        const handleMouseDown = (e) => {
          setIsDragging(true);
          lastMousePos.current = { x: e.clientX, y: e.clientY };
        };

        const handleTouchStart = (e) => {
          if (e.touches.length === 2) {
             // Pinch Start
             lastPinchDist.current = getTouchDistance(e.touches);
             setIsDragging(false); // Stop rotating if pinching
          } else if(e.touches.length === 1) {
             // Drag Start
             setIsDragging(true);
             lastMousePos.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
          }
        };

        const handleMouseMove = (e) => {
          if (!isDragging) return;
          const deltaX = e.clientX - lastMousePos.current.x;
          const deltaY = e.clientY - lastMousePos.current.y;
          
          let effectiveDeltaX = deltaX;
          let effectiveDeltaY = deltaY;

          if (isLandscapeMode) {
             effectiveDeltaX = deltaY; 
             effectiveDeltaY = -deltaX;
          }

          setRotationZ(prev => prev + effectiveDeltaX * 0.5);
          setViewAngleX(prev => Math.min(85, Math.max(10, prev - effectiveDeltaY * 0.5)));
          
          lastMousePos.current = { x: e.clientX, y: e.clientY };
        };

        const handleTouchMove = (e) => {
          if (e.touches.length === 2 && lastPinchDist.current !== null) {
             // Pinch Zoom Logic
             const currentDist = getTouchDistance(e.touches);
             const delta = currentDist - lastPinchDist.current;
             const zoomSpeed = 0.005; // Sensitivity
             
             setZoom(prev => Math.min(3, Math.max(0.2, prev + delta * zoomSpeed)));
             lastPinchDist.current = currentDist;
             
             return; // Skip rotation logic
          }

          if (!isDragging || e.touches.length !== 1) return;
          
          const deltaX = e.touches[0].clientX - lastMousePos.current.x;
          const deltaY = e.touches[0].clientY - lastMousePos.current.y;
          
          let effectiveDeltaX = deltaX;
          let effectiveDeltaY = deltaY;

          if (isLandscapeMode) {
             effectiveDeltaX = deltaY; 
             effectiveDeltaY = -deltaX;
          }

          setRotationZ(prev => prev + effectiveDeltaX * 0.5);
          setViewAngleX(prev => Math.min(85, Math.max(10, prev - effectiveDeltaY * 0.5)));
          
          lastMousePos.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        };

        const handleMouseUp = () => {
            setIsDragging(false);
            lastPinchDist.current = null;
        };
        
        const handleZoomIn = () => setZoom(prev => Math.min(3, prev + 0.2));
        const handleZoomOut = () => setZoom(prev => Math.max(0.2, prev - 0.2));

        // --- 3D Calculations ---
        // Use 100dvh for landscape mode to ensure full coverage (address bar fix)
        // Adjust standard scale logic slightly for landscape to fill height
        const canvasSize = isMobile ? (isLandscapeMode ? 320 : 200) : 280; 
        
        const baseWidthM = parseFloat(inputs.baseWidth) > 0 ? parseFloat(inputs.baseWidth) : Math.sqrt(inputs.baseArea || 100);
        const baseDepthM = (inputs.baseArea || 100) / baseWidthM;
        
        const scale = canvasSize / Math.max(baseWidthM, baseDepthM);
        
        const w = baseWidthM * scale;
        const d = baseDepthM * scale;

        const frontM = parseFloat(inputs.frontYardDepth) || 0;
        const backM = parseFloat(inputs.backYardDepth) || 0;
        const sideM = parseFloat(inputs.sideYardDepth) || 0;
        const sideDir = inputs.sideYardDirection || 'right';
        const roadW_M = parseFloat(inputs.roads.find(r => r.type === 'primary')?.width || inputs.roads[0]?.width || 6);
        const byRatio = parseFloat(inputs.minBackyardDepthRatio) || 0;

        const frontPx = frontM * scale;
        const backPx = backM * scale;
        const sidePx = sideM * scale;
        const roadW_Px = roadW_M * scale;

        const shiftX = sideDir === 'left' ? (sidePx / 2) : (-sidePx / 2);

        // Floors logic (Massing Simulation)
        const massingLayers = useMemo(() => {
            const layers = [];
            let remainingAreaM2 = Math.max(0, (res.totalCFA || 0) - (res.totalBasementArea || 0));
            let currentZM = 0;
            let floorCount = 0;
            const maxSimulatedFloors = 100;

            const buildBackM = backM;
            const buildFrontM = baseDepthM - frontM;
            const buildWidthM = Math.max(0, baseWidthM - sideM);

            const originHeightRatioY = baseDepthM + roadW_M; 
            const originWeiLaoY = baseDepthM + roadW_M / 2;

            while (remainingAreaM2 > 0.1 && floorCount < maxSimulatedFloors) {
                const h = (floorCount === 0) ? (parseFloat(inputs.floorHeight1F) || 4.2) : (parseFloat(inputs.floorHeightOther) || 3.6);
                const checkZ = currentZM + h;
                
                let limitFront = buildFrontM;
                let limitBack = buildBackM;

                if (showCheckLines) {
                    const cutY = originHeightRatioY - (checkZ / 3.6);
                    limitFront = Math.min(limitFront, cutY);
                }

                if (showCheckLines && showWeiLao) {
                    const cutY = originWeiLaoY - (checkZ / 5.0);
                    limitFront = Math.min(limitFront, cutY);
                }

                if (showCheckLines && byRatio > 0) {
                    const cutY = checkZ / byRatio;
                    limitBack = Math.max(limitBack, cutY);
                }

                const validDepthM = Math.max(0, limitFront - limitBack);
                const maxFloorAreaM2 = validDepthM * buildWidthM;

                if (maxFloorAreaM2 <= 1.0) {
                    break; 
                }

                const usedAreaM2 = Math.min(remainingAreaM2, maxFloorAreaM2);
                const usageRatio = usedAreaM2 / maxFloorAreaM2;
                const scaleFactor = Math.sqrt(usageRatio);
                
                const visualDepthM = validDepthM * scaleFactor;
                const visualWidthM = buildWidthM * scaleFactor;

                layers.push({
                    id: floorCount === 0 ? 'GF' : `${floorCount}F`,
                    z: currentZM * scale, 
                    height: Math.max(10, h * scale * 0.9), 
                    depthPx: visualDepthM * scale,
                    widthPx: visualWidthM * scale,
                    shiftYPx: ((limitBack + validDepthM / 2) - (baseDepthM / 2)) * scale
                });

                remainingAreaM2 -= usedAreaM2;
                currentZM += h;
                floorCount++;
            }

            return { layers, totalFloors: floorCount, totalHeight: currentZM };
        }, [res.totalCFA, res.totalBasementArea, baseDepthM, baseWidthM, frontM, backM, sideM, roadW_M, inputs.floorHeight1F, inputs.floorHeightOther, showCheckLines, showWeiLao, byRatio, scale]);

        const floorLayers = massingLayers.layers;
        const visualTotalH_Px = massingLayers.totalHeight * scale;
        const visualFloorsAbove = massingLayers.totalFloors;

        const colors = {
          bg: isDarkMode ? "#0f172a" : "#fafaf9", 
          grid: isDarkMode ? "linear-gradient(#1e293b 1px, transparent 1px), linear-gradient(90deg, #1e293b 1px, transparent 1px)" 
                           : "linear-gradient(#e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px)", 
          floor: showCheckLines 
                 ? (isDarkMode ? "rgba(255, 255, 255, 0.1)" : "rgba(255, 255, 255, 0.3)") 
                 : (isDarkMode ? "rgba(255, 255, 255, 0.9)" : "#ffffff"), 
          stroke: showCheckLines ? "#fb923c" : (isDarkMode ? "#94a3b8" : "#a8a29e")
        };

        const limitH_HeightRatio_M = 3.6 * (roadW_M + frontM);
        const limitH_HeightRatio_Px = limitH_HeightRatio_M * scale;
        const limitH_WeiLao_M = 5 * (0.5 * roadW_M + frontM);
        const limitH_WeiLao_Px = limitH_WeiLao_M * scale;
        const limitH_Backyard_M = byRatio * backM; 
        const limitH_Backyard_Px = limitH_Backyard_M * scale;

        const renderRoads = () => {
          const roadEls = inputs.roads.map((r, idx) => {
             const rW = parseFloat(r.width) * scale;
             const orientation = r.orientation; 
             const ext = 50 * scale; 
             let style = {};
             if (orientation === 'bottom') {
                style = { width: `calc(100% + ${ext*2}px)`, height: `${rW}px`, top: '100%', left: `-${ext}px`, transform: `translateY(2px)` };
             } else if (orientation === 'top') {
                style = { width: `calc(100% + ${ext*2}px)`, height: `${rW}px`, bottom: '100%', left: `-${ext}px`, transform: `translateY(-2px)` };
             } else if (orientation === 'left') {
                style = { width: `${rW}px`, height: `calc(100% + ${ext*2}px)`, right: '100%', top: `-${ext}px`, transform: `translateX(-2px)` };
             } else { 
                style = { width: `${rW}px`, height: `calc(100% + ${ext*2}px)`, left: '100%', top: `-${ext}px`, transform: `translateX(2px)` };
             }
             return (
               <div key={r.id} className={`absolute flex items-center justify-center text-sm font-bold border-dashed border-stone-300 z-10 ${isDarkMode ? 'bg-slate-800 border-slate-600 text-slate-400' : 'bg-stone-200/50 text-stone-600'}`} style={{ ...style, position: 'absolute' }}>{r.name} ({r.width}m)</div>
             );
          });
          return roadEls;
        };

        // 定義橫向全螢幕的樣式 - 修正為 100dvh 以確保滿版，且調整控制列位置
        const landscapeStyle = isLandscapeMode ? {
            position: 'fixed',
            top: 0,
            left: '100vw', 
            width: '100dvh', // Use dvh for mobile browsers to handle URL bar
            height: '100vw', 
            transform: 'rotate(90deg)',
            transformOrigin: 'top left',
            zIndex: 9999,
            margin: 0,
            borderRadius: 0,
            touchAction: 'none',
            backgroundColor: isDarkMode ? '#0f172a' : '#fafaf9'
        } : { 
            backgroundImage: colors.grid, 
            backgroundSize: '40px 40px', 
            touchAction: 'none'
        };

        // Landscape mode UI adjustments
        // Use larger padding in landscape mode to avoid corner clipping
        const controlBarClass = isLandscapeMode ? "absolute top-6 right-6 z-30 flex gap-2" : "absolute top-4 right-4 z-30 flex gap-2";

        return (
          <div className="bg-[#fdfbf7] rounded-xl p-0 mb-6 shadow-md overflow-hidden relative min-h-[350px] md:min-h-[600px] flex flex-col md:flex-row border border-stone-300 font-['GenYoGothic',_sans-serif] md:sticky md:top-0 md:z-40">
             
             <div className="flex flex-col md:flex-row w-full h-full relative">
                
                <div ref={viewportRef} className={`flex-1 relative flex flex-col items-center justify-center perspective-1000 min-h-[350px] md:min-h-[600px] overflow-hidden transition-colors duration-500 ${isDragging ? 'cursor-grabbing' : 'cursor-grab'} ${isDarkMode ? 'bg-slate-900' : 'bg-[#fafaf9]'}`}
                     style={{
                        ...landscapeStyle,
                        ...(isLandscapeMode ? {} : { backgroundImage: colors.grid, backgroundSize: '40px 40px' })
                     }}
                     onMouseDown={handleMouseDown}
                     onMouseMove={handleMouseMove}
                     onMouseUp={handleMouseUp}
                     onMouseLeave={handleMouseUp}
                     onTouchStart={handleTouchStart}
                     onTouchMove={handleTouchMove}
                     onTouchEnd={handleMouseUp}
                >
                  
                  {/* 控制列 - Dynamic Positioning */}
                  <div className={controlBarClass}>
                     <div className={`${isDarkMode ? 'bg-slate-800/80 border-slate-700' : 'bg-white/90 border-stone-200'} p-1 rounded-full border shadow-lg flex items-center gap-1 backdrop-blur-md transition-colors duration-300`}>
                        <button onClick={handleZoomOut} className={`p-2 rounded-full transition-all ${isDarkMode ? 'text-slate-300 hover:bg-slate-600' : 'text-slate-600 hover:bg-stone-100'}`} title="縮小">
                          <ZoomOut size={18} />
                        </button>
                        <div className={`w-[1px] h-4 ${isDarkMode ? 'bg-slate-600' : 'bg-stone-200'}`}></div>
                        <button onClick={handleZoomIn} className={`p-2 rounded-full transition-all ${isDarkMode ? 'text-slate-300 hover:bg-slate-600' : 'text-slate-600 hover:bg-stone-100'}`} title="放大">
                          <ZoomIn size={18} />
                        </button>
                        <div className={`w-[1px] h-4 ${isDarkMode ? 'bg-slate-600' : 'bg-stone-200'}`}></div>
                        <button onClick={() => setIsDarkMode(!isDarkMode)} className={`p-2 rounded-full transition-all ${isDarkMode ? 'text-yellow-400 hover:bg-slate-600' : 'text-slate-600 hover:bg-stone-100'}`} title={isDarkMode ? "切換至淺色模式" : "切換至深色模式"}>
                          {isDarkMode ? <Sun size={18} /> : <Moon size={18} />}
                        </button>
                        <div className={`w-[1px] h-4 ${isDarkMode ? 'bg-slate-600' : 'bg-stone-200'}`}></div>
                        
                        {/* 修正：文字改為 全螢幕模式 */}
                        <button 
                           onClick={() => setIsSummaryOpen(!isSummaryOpen)} 
                           className={`p-2 rounded-full transition-all ${isDarkMode ? 'text-indigo-400 hover:bg-slate-600' : 'text-indigo-600 hover:bg-stone-100'}`} 
                           title={isSummaryOpen ? "全螢幕模式 (隱藏面板)" : "顯示詳細面板"}
                        >
                           {isSummaryOpen ? <Maximize size={18} /> : <PanelRightOpen size={18} />}
                        </button>
                     </div>
                  </div>

                  <div className="absolute top-8 left-8 z-20 pointer-events-none">
                    <ArtisticCompass className="w-20 h-20 md:w-24 md:h-24" rotation={-rotationZ} isDarkMode={isDarkMode} />
                  </div>

                  <div className="relative w-full h-full flex items-center justify-center pointer-events-none" style={{ perspective: '2500px', transformStyle: 'preserve-3d' }}>
                    <div style={{ 
                      transform: `rotateX(${viewAngleX}deg) rotateZ(${rotationZ}deg) scale3d(${zoom}, ${zoom}, ${zoom})`, 
                      transformStyle: 'preserve-3d', 
                      transition: isDragging ? 'none' : 'transform 0.1s ease-out' 
                    }}>
                       
                       <div style={{ 
                           position: 'relative', 
                           width: `${w}px`, 
                           height: `${d}px`, 
                           backgroundColor: isDarkMode ? 'rgba(30, 41, 59, 0.6)' : 'rgba(168, 162, 158, 0.4)',
                           transformStyle: 'preserve-3d',
                           transition: 'background-color 0.5s'
                        }}>
                          <div className={`absolute border shadow-2xl transition-colors duration-500 ${isDarkMode ? 'bg-slate-800/80 border-slate-600' : 'bg-transparent border-stone-300'}`} style={{ width: '100%', height: '100%', boxShadow: isDarkMode ? '0 0 20px rgba(0,0,0,0.5)' : 'none' }}>
                             {renderRoads()}
                             {showCheckLines && (
                               <>
                                 {frontPx > 0 && <div className="absolute bottom-0 left-0 right-0 border-t border-dashed flex items-end justify-center bg-rose-50/40 border-rose-200" style={{ height: `${frontPx}px` }}><span className="text-sm font-bold text-rose-500 bg-white/80 px-1 rounded mb-1">前院 {inputs.frontYardDepth}m</span></div>}
                                 {backPx > 0 && <div className="absolute top-0 left-0 right-0 border-b border-dashed flex items-start justify-center bg-emerald-50/40 border-emerald-200" style={{ height: `${backPx}px` }}><span className="text-sm font-bold text-emerald-600 bg-white/80 px-1 rounded mt-1">後院 {inputs.backYardDepth}m</span></div>}
                                 {sidePx > 0 && <div className={`absolute top-0 bottom-0 border-dashed flex items-center justify-center bg-slate-50/40 border-slate-200 ${sideDir === 'left' ? 'left-0 border-r' : 'right-0 border-l'}`} style={{ width: `${sidePx}px` }}><span className="text-sm font-bold text-slate-600 bg-white/80 px-1 rounded transform rotate-90">側院 {inputs.sideYardDepth}m</span></div>}
                               </>
                             )}
                          </div>
                          {Array.from({length: floorsBelow}).map((_, i) => (
                            <div key={`bm-${i}`} className={`absolute border border-dashed ${isDarkMode ? 'border-slate-600 bg-slate-800/50' : 'border-stone-400 bg-stone-200/50'}`}
                                 style={{ width: `${w*0.8}px`, height: `${d*0.8}px`, left: '50%', top: '50%', transform: `translate(-50%, -50%) translateZ(${-(i+1)*Math.max(20, 3.6*scale*0.8)}px)` }}>
                            </div>
                          ))}
                          {floorLayers.map((layer, i) => (
                            <BuildingLayer 
                              key={`fl-${i}`}
                              width={layer.widthPx}
                              depth={layer.depthPx}
                              height={layer.height}
                              x={shiftX}
                              y={layer.shiftYPx}
                              z={layer.z}
                              color={colors.floor}
                              strokeColor={colors.stroke}
                              showFrame={true}
                              opacity={1}
                              visible={true}
                              isSlabMode={!showCheckLines}
                              animate={animate}
                              delay={i * 50}
                              isDarkMode={isDarkMode}
                            />
                          ))}
                          <div className="absolute" style={{ left: '50%', top: '50%', transform: `translate3d(${shiftX + w/2 + 40}px, ${d/2}px, 0px) rotateX(-90deg) rotateY(0deg)` }}>
                                <div className={`border-l-[3px] ${isDarkMode ? 'border-stone-400' : 'border-stone-600'}`} style={{ height: `${visualTotalH_Px}px`, position: 'absolute', bottom: 0 }}></div>
                                <div className={`absolute bottom-0 left-[-3px] w-2 h-2 rounded-full ${isDarkMode ? 'bg-stone-400' : 'bg-stone-600'}`}></div>
                                <div className="absolute left-[-6px]" style={{ bottom: `${visualTotalH_Px - 2}px` }}>
                                  <div className={`w-0 h-0 border-l-[7px] border-l-transparent border-r-[7px] border-r-transparent border-b-[10px] ${isDarkMode ? 'border-b-stone-400' : 'border-b-stone-600'}`}></div>
                                </div>
                                <div className={`absolute left-4 text-xl font-bold whitespace-nowrap ${isDarkMode ? 'text-stone-200' : 'text-stone-700'}`} style={{ bottom: `${visualTotalH_Px / 2}px`, transform: 'translateY(50%)' }}>1F~{visualFloorsAbove}F</div>
                          </div>
                          {showCheckLines && (
                             <>
                                <CheckLine start={{ x: w/2, y: d + roadW_Px, z: 0 }} end={{ x: w/2, y: d - frontPx, z: limitH_HeightRatio_Px }} color="#f43f5e" label="高度比" baseRotation={0} viewAngleX={viewAngleX} rotationZ={rotationZ} visible={true} dashed={true} thick={true} isDarkMode={isDarkMode} labelPosRatio={0.2} />
                                {showWeiLao && <CheckLine start={{ x: w/2, y: d + roadW_Px/2, z: 0 }} end={{ x: w/2, y: d - frontPx, z: limitH_WeiLao_Px }} color={isDarkMode ? "#a855f7" : "#8b5cf6"} label="危老檢討" baseRotation={0} viewAngleX={viewAngleX} rotationZ={rotationZ} visible={true} dashed={true} thick={true} isDarkMode={isDarkMode} labelPosRatio={0.2} />}
                                {byRatio > 0 && <CheckLine start={{ x: w/2, y: 0, z: 0 }} end={{ x: w/2, y: backPx, z: limitH_Backyard_Px }} color={isDarkMode ? "#38bdf8" : "#0ea5e9"} label="後院比" baseRotation={0} viewAngleX={viewAngleX} rotationZ={rotationZ} visible={true} dashed={true} thick={true} isDarkMode={isDarkMode} />}
                             </>
                          )}
                       </div>
                    </div>
                  </div>

                  <div className="absolute bottom-4 left-0 w-full z-40 px-4 flex justify-center pointer-events-none">
                    <div className={`pointer-events-auto rounded-2xl border shadow-lg flex items-center justify-center p-2 backdrop-blur-md transition-colors max-w-full overflow-x-auto no-scrollbar ${isDarkMode ? 'bg-slate-900/90 border-slate-700' : 'bg-white/80 border-white/50'}`}>
                        <div className="flex items-center gap-4 px-2 whitespace-nowrap">
                            {showCheckLines ? (
                              <>
                                 <LegendItem color={isDarkMode?"bg-rose-500/20 border-rose-500":"bg-rose-200 border-rose-300"} label="前院" value={`${inputs.frontYardDepth||0}m`} textColor={isDarkMode?"text-slate-200":"text-stone-600"} valueColor={isDarkMode?"text-slate-400":"text-stone-400"} />
                                 <LegendItem color={isDarkMode?"bg-emerald-500/20 border-emerald-500":"bg-emerald-200 border-emerald-300"} label="後院" value={`${inputs.backYardDepth||0}m`} textColor={isDarkMode?"text-slate-200":"text-stone-600"} valueColor={isDarkMode?"text-slate-400":"text-stone-400"} />
                                 <LegendItem color={isDarkMode?"bg-sky-500/20 border-sky-500":"bg-slate-200 border-slate-300"} label="側院" value={`${inputs.sideYardDepth||0}m`} textColor={isDarkMode?"text-slate-200":"text-stone-600"} valueColor={isDarkMode?"text-slate-400":"text-stone-400"} />
                                 <div className={`w-[1px] h-4 flex-shrink-0 ${isDarkMode ? 'bg-slate-700' : 'bg-stone-300'}`}></div>
                                 {showWeiLao && <LegendItem type="line" color={isDarkMode?"bg-purple-400":"bg-purple-500"} label="危老檢討線" textColor={isDarkMode?"text-slate-200":"text-stone-600"} />}
                                 <LegendItem type="line" color="bg-rose-500" label="高度比檢討線" textColor={isDarkMode?"text-slate-200":"text-stone-600"} />
                                 {byRatio > 0 && <LegendItem type="line" color={isDarkMode?"bg-sky-400":"bg-sky-500"} label="後院檢討線" textColor={isDarkMode?"text-slate-200":"text-stone-600"} />}
                              </>
                            ) : (
                              <>
                                <InfoItem label="基地面積" value={formatNum(res.base)} unit="m²" isDarkMode={isDarkMode} />
                                <div className={`w-[1px] h-4 flex-shrink-0 ${isDarkMode ? 'bg-slate-700' : 'bg-stone-300'}`}></div>
                                <InfoItem label="建蔽率" value={formatNum(inputs.coverageRatio)} unit="%" isDarkMode={isDarkMode} />
                                <div className={`w-[1px] h-4 flex-shrink-0 ${isDarkMode ? 'bg-slate-700' : 'bg-stone-300'}`}></div>
                                <InfoItem label="容積率" value={formatNum(inputs.floorRatio)} unit="%" isDarkMode={isDarkMode} />
                                <div className={`w-[1px] h-4 flex-shrink-0 ${isDarkMode ? 'bg-slate-700' : 'bg-stone-300'}`}></div>
                                <InfoItem label="樓層數" value={`${visualFloorsAbove}F / B${inputs.floorsBelow}`} isDarkMode={isDarkMode} />
                              </>
                            )}
                        </div>
                    </div>
                  </div>
                </div>

                <div className={`transition-all duration-500 ease-in-out border-l border-stone-200 bg-[#f8fafc] flex flex-col num-font z-10 relative overflow-hidden ${isSummaryOpen ? 'w-full md:w-96 opacity-100' : 'w-0 opacity-0 border-none'}`}>
                   
                   <div className="flex-1 overflow-y-auto p-6">
                      <div className="mb-6 border-b border-stone-200 pb-4 sticky top-0 bg-white/95 backdrop-blur z-40 -mt-6 -mx-6 px-6 pt-6 shadow-sm">
                         <div className="flex items-center justify-between">
                           <h3 className="text-stone-400 text-sm font-bold uppercase tracking-widest flex items-center gap-2">
                              <Building2 size={16} /> Project Summary
                           </h3>
                           <div className="w-6"></div> 
                         </div>
                         
                         <div className="space-y-3 mt-4">
                            <SummaryRow label="專案名稱" value={inputs.projectName} />
                            <SummaryRow label="工程預算" value={`${formatNum(res.estimatedBudget)} 萬`} highlight />
                            <SummaryRow label="建築物高度" value={`${formatNum(massingLayers.totalHeight)} m`} />
                            {/* Updated Summary Row to show simulated floors */}
                            <SummaryRow label="模擬樓層" value={`${visualFloorsAbove} 層`} subtext="(含退縮)" />
                            
                            {showCheckLines && (
                              <SummaryRow label="高度比" value={res.heightRatio} isAlert={res.isHighRise} alertText={res.isSuperHighRise ? "超高" : "高層"} />
                            )}
                            
                            <div className="pt-2 border-t border-stone-200 mt-2">
                               <div className="flex justify-between items-center mb-2">
                                   <span className="text-stone-500 text-sm font-medium">檢討線顯示</span>
                                   <button onClick={() => setShowCheckLines(!showCheckLines)} className={`px-3 py-1 rounded-full border shadow-sm flex items-center gap-2 text-xs font-bold transition-colors ${showCheckLines ? 'bg-indigo-50 border-indigo-200 text-indigo-600' : 'bg-white border-stone-200 text-stone-500'}`}>
                                      {showCheckLines ? <ToggleRight size={16} /> : <ToggleLeft size={16} />}
                                      {showCheckLines ? "開啟" : "關閉"}
                                   </button>
                               </div>
                               
                               {showCheckLines && (
                                   <div className="flex justify-between items-center pl-2 border-l-2 border-indigo-100 ml-1">
                                       <span className="text-stone-400 text-xs font-medium">↳ 危老檢討線</span>
                                       <button onClick={() => setShowWeiLao(!showWeiLao)} className={`px-2 py-0.5 rounded border shadow-sm flex items-center gap-1 text-[10px] font-bold transition-colors ${showWeiLao ? 'bg-purple-50 border-purple-200 text-purple-600' : 'bg-white border-stone-200 text-stone-400'}`}>
                                          {showWeiLao ? "顯示" : "隱藏"}
                                       </button>
                                   </div>
                               )}
                            </div>
                         </div>
                      </div>

                      <div className="grid grid-cols-2 gap-3">
                         <div className="bg-white p-3 rounded-lg border border-stone-200">
                            <div className="text-stone-400 text-[10px] uppercase mb-1">總樓地板 (坪)</div>
                            <div className="font-bold text-lg num-font text-stone-700">{formatNum(toPing(res.totalCFA))} <span className="text-xs font-sans font-normal text-stone-400">Total CFA</span></div>
                         </div>
                         <div className="bg-white p-3 rounded-lg border border-stone-200">
                            <div className="text-stone-400 text-[10px] uppercase mb-1">預估坪效</div>
                            <div className="font-bold text-lg num-font text-emerald-600">{formatNum(res.efficiency)} <span className="text-xs font-sans font-normal text-stone-400">倍</span></div>
                         </div>
                         <div className="bg-white p-3 rounded-lg border border-stone-200">
                            <div className="text-stone-400 text-[10px] uppercase mb-1">樓層</div>
                            {/* Updated to show visual floors */}
                            <div className="font-bold text-lg num-font text-indigo-600">{visualFloorsAbove}F <span className="text-xs font-sans font-normal text-stone-400">/ B{inputs.floorsBelow}</span></div>
                         </div>
                         <div className="bg-white p-3 rounded-lg border border-stone-200">
                            <div className="text-stone-400 text-[10px] uppercase mb-1">停車</div>
                            <div className="font-bold text-lg num-font text-stone-700">{res.possibleParking} <span className="text-xs font-sans font-normal text-stone-400">部</span></div>
                         </div>
                      </div>
                   </div>
                   
                   <div className="p-6 bg-white border-t border-stone-200 mt-auto">
                      <div className="text-stone-400 text-sm font-bold uppercase mb-4 flex items-center gap-2"><Car size={14} /> 停車空間預估</div>
                      <div className="flex justify-between items-center">
                         <div className="flex items-center gap-3">
                            <div className="p-2 bg-stone-100 rounded text-stone-600"><Car size={18} /></div>
                            <div>
                               <div className="text-xs text-stone-400">汽車位</div>
                               <div className="font-bold text-stone-800 text-lg num-font">{res.possibleParking}</div>
                            </div>
                         </div>
                         <div className="h-8 w-[1px] bg-stone-200"></div>
                         <div className="flex items-center gap-3">
                            <div className="p-2 bg-stone-100 rounded text-stone-600"><Bike size={18} /></div>
                            <div>
                               <div className="text-xs text-stone-400">機車位</div>
                               <div className="font-bold text-stone-800 text-lg num-font">{Math.floor(res.possibleParking * 1.2)}</div>
                            </div>
                         </div>
                      </div>
                   </div>
                </div>
             </div>
          </div>
        );
      };

      const CheckLine = ({ start, end, color, label, rotationZ, baseRotation, viewAngleX, visible, dashed, thick, labelPosRatio = 0.5, isDarkMode }) => {
        const dx = end.x - start.x;
        const dy = end.y - start.y;
        const dz = end.z - start.z;
        const length = Math.sqrt(dx * dx + dy * dy + dz * dz);
        
        const lx = start.x + dx * labelPosRatio;
        const ly = start.y + dy * labelPosRatio;
        const lz = start.z + dz * labelPosRatio;

        const angleZ = Math.atan2(dy, dx) * (180 / Math.PI);
        const angleY = -Math.atan2(dz, Math.sqrt(dx * dx + dy * dy)) * (180 / Math.PI);

        const isSteep = viewAngleX > 75;
        const thickness = thick ? (isSteep ? "6px" : "3px") : (isSteep ? "4px" : "2px");

        return (
          <>
            <div className="absolute origin-left" style={{
                left: 0, top: 0,
                width: `${length}px`, height: thickness,
                backgroundColor: dashed ? 'transparent' : color,
                borderTop: dashed ? `2px dashed ${color}` : 'none',
                transform: `translate3d(${start.x}px, ${start.y}px, ${start.z}px) rotateZ(${angleZ}deg) rotateY(${angleY}deg)`,
                opacity: visible ? (isSteep ? 1 : 0.9) : 0,
                pointerEvents: 'none',
                boxShadow: isSteep ? `0 0 4px ${color}` : 'none'
            }}></div>
            
            {isSteep && (
              <div className="absolute origin-left" style={{
                  left: 0, top: 0,
                  width: `${length}px`, height: thickness,
                  backgroundColor: color,
                  transform: `translate3d(${start.x}px, ${start.y}px, ${start.z}px) rotateZ(${angleZ}deg) rotateY(${angleY}deg) rotateX(90deg)`,
                  opacity: visible ? 1 : 0,
                  pointerEvents: 'none'
              }}></div>
            )}

            {visible && label && (
              <Si 
                text={label} x={lx} y={ly} z={lz + 10} 
                rotationZ={rotationZ} baseRotation={baseRotation} viewAngleX={viewAngleX} 
                visible={visible} 
                className={`text-[10px] px-2 py-0.5 rounded-full shadow-lg font-bold border ${isDarkMode ? 'bg-slate-900 border-slate-600 text-white' : 'bg-white/90 border-slate-200 text-slate-600'}`}
              />
            )}
          </>
        );
      };

      const Si = ({ text, x, y, z, rotationZ, baseRotation, viewAngleX, visible, className, lineConnector }) => (
        visible ? (
          <div className="absolute pointer-events-none" style={{ 
              left: 0, top: 0, 
              transform: `translate3d(${x}px, ${y}px, ${z}px) rotateZ(${-(rotationZ + baseRotation)}deg) rotateX(${-viewAngleX}deg)`,
              zIndex: 5000 
          }}>
            <div className="flex items-center" style={{ transform: 'translate(-50%, -50%)' }}>
              {lineConnector && <div className="w-4 h-[1px] bg-stone-400"></div>}
              <div className={`whitespace-nowrap px-2 py-0.5 rounded shadow-sm text-sm backdrop-blur-sm num-font ${className}`}>
                {text}
              </div>
            </div>
          </div>
        ) : null
      );

      const CollapsibleSection = ({ title, icon, children, defaultOpen = true, className = "" }) => {
        const [isOpen, setIsOpen] = useState(defaultOpen);
        return (
          <div className={`bg-white rounded-xl shadow-sm border border-stone-100 overflow-hidden ${className}`}>
            <div className="flex items-center justify-between p-5 cursor-pointer hover:bg-stone-50 transition-colors border-b border-stone-100" onClick={() => setIsOpen(!isOpen)}>
              <h3 className="font-bold text-stone-700 flex items-center gap-2">{icon} {title}</h3>
              <div className="text-stone-400">{isOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}</div>
            </div>
            <div className={`transition-all duration-300 ease-in-out overflow-hidden ${isOpen ? 'max-h-[1200px] opacity-100' : 'max-h-0 opacity-0'}`}>
              <div className="p-5">{children}</div>
            </div>
          </div>
        );
      };

      const InputRow = ({ id, label, value, calculatedValue, formula, note, isEditMode, onOverride, highlight = false, subTotal = false, bold = false, paramKey, paramValue, onParamChange }) => {
        const isConflict = isEditMode && calculatedValue !== undefined && Math.abs(value - calculatedValue) > 0.01;
        
        const displayValue = formatNum(value);
        const displayPing = formatNum(toPing(value));

        return (
          <tr className={`hover:bg-stone-50 ${subTotal ? 'bg-stone-50/80 italic text-stone-600' : ''}`}>
            <td className={`p-4 pl-8 border-l-4 ${highlight ? 'border-emerald-400 font-bold text-emerald-700' : 'border-stone-300'} ${bold ? 'font-bold' : 'font-medium'}`}>
              {label}
            </td>
            <td className={`p-4 text-right ${highlight ? 'font-bold text-emerald-700' : ''} ${bold ? 'font-bold' : ''}`}>
              {isEditMode ? (
                <div className="flex items-center justify-end gap-2 relative">
                  {isConflict && <div className="absolute right-full mr-2 text-rose-500 animate-pulse" title="警告：數值與公式計算結果衝突"><AlertTriangle size={16} /></div>}
                  <input type="number" value={value} onChange={(e) => onOverride(id, e.target.value)} className={`w-24 p-1 text-right border rounded outline-none focus:ring-2 ${isConflict ? 'border-rose-300 focus:ring-rose-200 bg-rose-50' : 'border-stone-300 focus:ring-indigo-200'} num-font`} />
                </div>
              ) : (
                <span className="num-font">{displayValue}</span>
              )}
            </td>
            <td className={`p-4 text-right text-stone-500 ${highlight ? 'font-bold text-emerald-700' : ''} ${bold ? 'font-bold' : ''} num-font`}>
              {displayPing}
            </td>
            {isEditMode && (
              <>
                <td className="p-4 font-mono text-xs text-indigo-600/80 bg-indigo-50/10 border-l border-stone-100">
                   {paramKey ? (
                     <div className="flex items-center gap-2">
                       <span className="text-stone-500">{paramKey === 'exemptRate' ? '免計率' : paramKey === 'stairRate' ? '梯廳率' : '陽台率'}:</span>
                       <input type="number" value={paramValue} onChange={(e) => onParamChange(paramKey, e.target.value)} className="w-16 p-1 border rounded text-center font-bold text-indigo-700 num-font" style={{ fontSize: '12px' }}/>
                       <span>%</span>
                     </div>
                   ) : formula}
                </td>
                <td className="p-4 text-sm text-stone-500 bg-indigo-50/10">{note}</td>
              </>
            )}
          </tr>
        );
      };

      const SectionHeader = ({ title }) => (
        <tr className="bg-stone-200 text-stone-800">
          <td colSpan={10} className="p-2 pl-4 font-bold text-xs uppercase tracking-wider">{title}</td>
        </tr>
      );

      const Cal = () => {
        const [lots, setLots] = useState([{ id: 1, lot: '___段___地號', area: 239.12 }]);
        const [inputs, setInputs] = useState({
          projectName: '',
          district: '南投縣中興新村',
          roads: [{ id: 1, name: '向陽路', width: 10, orientation: 'bottom', type: 'primary' }],
          zoneType: '住宅區', urbanPlanName: '中興新村都市計畫區',
          coverageRatio: 50, floorRatio: 150, excavationRatio: 60, floorsBelow: 1, avgCarArea: 35,
          frontYardDepth: 4, sideYardDepth: 1.5, sideYardDirection: 'right', backYardDepth: 3,
          floorHeight1F: 4.2, floorHeightOther: 3.6,
          baseWidth: '', 
          incentiveArea: 0, transferArea: 0,
          minBackyardDepthRatio: 0
        });
        const [params, setParams] = useState({ exemptRate: 15, stairRate: 5, balconyRate: 10, pricePerPing: 25 });
        const [isEditMode, setIsEditMode] = useState(false);
        const [overrides, setOverrides] = useState({});
        const [showDetail, setShowDetail] = useState(true);

        const updateLot = (id, field, value) => {
          setLots(prev => prev.map(l => l.id === id ? { ...l, [field]: field === 'area' ? (parseFloat(value) || 0) : value } : l));
        };
        const addLot = () => {
          const newId = Math.max(...lots.map(l => l.id), 0) + 1;
          setLots([...lots, { id: newId, lot: '', area: 0 }]);
        };
        const removeLot = (id) => {
          if (lots.length > 1) setLots(lots.filter(l => l.id !== id));
        };
        const updateRoad = (id, field, value) => {
          setInputs(prev => ({ ...prev, roads: prev.roads.map(r => r.id === id ? { ...r, [field]: value } : r) }));
        };
        const addRoad = () => {
          const newId = Math.max(...inputs.roads.map(r => r.id), 0) + 1;
          setInputs(prev => ({ ...prev, roads: [...prev.roads, { id: newId, name: '新道路', width: 6, orientation: 'left', type: 'secondary' }] }));
        };
        const removeRoad = (id) => {
          if (inputs.roads.length > 1) setInputs(prev => ({ ...prev, roads: prev.roads.filter(r => r.id !== id) }));
        };

        const totalBaseArea = useMemo(() => lots.reduce((acc, curr) => acc + curr.area, 0), [lots]);

        const results = useMemo(() => {
          const base = totalBaseArea;
          const maxBuildingArea = base * (inputs.coverageRatio / 100);
          const statutoryFA = base * (inputs.floorRatio / 100); 
          
          const exempt15 = statutoryFA * (params.exemptRate / 100);
          const exemptStair = statutoryFA * (params.stairRate / 100);
          const exemptIndoor = exempt15 + exemptStair;
          const balcony = statutoryFA * (params.balconyRate / 100);
          
          const incentive = parseFloat(inputs.incentiveArea) || 0;
          const transfer = parseFloat(inputs.transferArea) || 0;
          
          const permittedIndoor = statutoryFA + exemptIndoor + incentive + transfer;
          
          const roofProtrusion = maxBuildingArea * 0.125 * 2;
          
          const basementAreaPerFloor = base * (inputs.excavationRatio / 100);
          const totalBasementArea = basementAreaPerFloor * inputs.floorsBelow;
          
          const totalCFA = permittedIndoor + balcony + roofProtrusion + totalBasementArea;
          
          const efficiency = toPing(base) > 0 ? toPing(totalCFA) / toPing(base) : 0;
          
          const statutoryParking = Math.floor(totalCFA / 150);
          const possibleParking = Math.floor(totalBasementArea / inputs.avgCarArea);
          
          const calculatedFloors = maxBuildingArea > 0 ? permittedIndoor / maxBuildingArea : 0;
          const floorsAbove = Math.ceil(calculatedFloors);
          
          const estimatedBudget = toPing(totalCFA) * params.pricePerPing;

          const fh1 = parseFloat(inputs.floorHeight1F) || 0;
          const fhO = parseFloat(inputs.floorHeightOther) || 0;
          const buildingHeight = fh1 + (fhO * Math.max(0, floorsAbove - 1)) + 9;

          const mainRoad = inputs.roads.find(r => r.type === 'primary') || inputs.roads[0];
          const roadWidth = mainRoad ? parseFloat(mainRoad.width) : 0;
          const frontYard = parseFloat(inputs.frontYardDepth) || 0;
          const backYard = parseFloat(inputs.backYardDepth) || 0;
          
          const heightRatio = (roadWidth + frontYard) > 0 ? buildingHeight / (roadWidth + frontYard) : 0;
          const backyardDepthRatio = backYard > 0 ? buildingHeight / backYard : 0;
          
          const isHighRise = buildingHeight > 24;
          const isSuperHighRise = buildingHeight > 100;
          
          const weiLaoRatio = (0.5 * roadWidth + frontYard) > 0 ? 5 / (0.5 * roadWidth + frontYard) : 0;

          return {
            base, maxBuildingArea, statutoryFA,
            exempt15, exemptStair, exemptIndoor, balcony,
            permittedIndoor, roofProtrusion,
            basementAreaPerFloor, totalBasementArea,
            totalCFA, efficiency,
            statutoryParking, possibleParking,
            calculatedFloors, floorsAbove,
            estimatedBudget,
            buildingHeight, heightRatio, backyardDepthRatio,
            isHighRise, isSuperHighRise, weiLaoRatio
          };
        }, [inputs, totalBaseArea, params]);

        const finalRes = { ...results, ...overrides };

        const handleInputChange = (e) => {
          const { name, value } = e.target;
          setInputs(prev => ({ ...prev, [name]: value }));
        };
        const handleOverride = (id, value) => {
          const val = parseFloat(value);
          if (!isNaN(val)) setOverrides(prev => ({ ...prev, [id]: val }));
        };
        const handleParamChange = (key, value) => {
          setParams(prev => ({ ...prev, [key]: parseFloat(value) || 0 }));
        };
        const updateBaseDim = (key, val) => {
          setInputs(prev => ({ ...prev, [key]: val }));
        };

        const inputClass = "w-full p-2 border border-stone-200 rounded-md outline-none transition-all focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 text-stone-700 text-sm num-font";
        const labelClass = "block text-sm font-bold text-stone-500 uppercase mb-1";

        return (
          <div className="min-h-screen bg-stone-50 p-4 md:p-8 text-stone-800">
            <div className="max-w-7xl mx-auto space-y-6">
              
              <header className="flex flex-col md:flex-row justify-between items-start md:items-center bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                <div>
                  <h1 className="text-3xl font-serif font-bold flex items-center gap-3 text-stone-800">
                    <Building2 className="text-stone-600" size={32} />
                    自地自建評估計算書
                  </h1>
                  <p className="text-stone-500 font-medium mt-1 ml-1">基地開發效益評估 / 容積獎勵檢討 / 停車空間規劃</p>
                </div>
                <div className="flex items-center gap-4 mt-4 md:mt-0">
                  <div className="flex flex-col mr-4">
                    <label className="text-xs text-stone-400 font-bold uppercase">專案名稱</label>
                    <input type="text" name="projectName" value={inputs.projectName} onChange={handleInputChange} placeholder="輸入專案名稱" className="border-b border-stone-300 focus:border-stone-800 outline-none bg-transparent py-1 text-lg font-bold text-stone-800" />
                  </div>
                  <button onClick={() => setIsEditMode(!isEditMode)} className={`w-12 h-12 flex items-center justify-center rounded-full transition-all duration-300 shadow-sm border ${isEditMode ? 'bg-stone-800 border-stone-800 text-white' : 'bg-white border-stone-200 text-stone-400 hover:border-stone-400'}`}>
                    {isEditMode ? <Settings2 size={20} /> : <Pencil className="w-6 h-6" />}
                  </button>
                </div>
              </header>

              <Visualizer3D inputs={{...inputs, baseArea: totalBaseArea, floorsAbove: finalRes.floorsAbove}} res={finalRes} onUpdateBaseDim={updateBaseDim} />

              <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">
                
                <CollapsibleSection title="基本資料" icon={<MapPin size={18} className="text-rose-500" />} className="xl:col-span-1">
                  <div className="space-y-3">
                    <div>
                      <label className={labelClass}>行政區</label>
                      <input type="text" name="district" value={inputs.district} onChange={handleInputChange} className={inputClass} />
                    </div>
                    
                    <div className="space-y-2">
                      <div className="flex justify-between items-center">
                        <label className={labelClass}>地號與面積 (㎡)</label>
                        <button onClick={addLot} className="text-indigo-500 hover:text-indigo-700 text-sm flex items-center gap-1"><Plus size={12} /> 新增</button>
                      </div>
                      <div className="max-h-40 overflow-y-auto pr-1 space-y-2">
                        {lots.map(l => (
                          <div key={l.id} className="flex gap-2 items-center group">
                            <input type="text" placeholder="地號" value={l.lot} onChange={(e) => updateLot(l.id, 'lot', e.target.value)} className={`${inputClass} text-sm`} />
                            <input type="number" placeholder="面積" value={l.area} onChange={(e) => updateLot(l.id, 'area', e.target.value)} className={`${inputClass} text-sm w-24 text-right`} />
                            {lots.length > 1 && <button onClick={() => removeLot(l.id)} className="text-stone-300 hover:text-rose-500"><Trash2 size={14} /></button>}
                          </div>
                        ))}
                      </div>
                      <div className="text-right text-sm font-bold text-stone-500 pt-1 border-t">合計: {formatNum(totalBaseArea)} ㎡ ({formatNum(toPing(totalBaseArea))} 坪)</div>
                    </div>

                    <div className="space-y-3 mt-4 pt-4 border-t border-stone-100">
                       <div className="flex justify-between items-center">
                          <label className={labelClass}>臨路狀況與方位</label>
                          <button onClick={addRoad} className="text-indigo-500 hover:text-indigo-700 text-sm flex items-center gap-1"><Plus size={12} /> 新增道路</button>
                       </div>
                       <div className="space-y-2">
                          <div className="grid grid-cols-12 gap-2 text-xs text-stone-400 font-bold mb-1 px-1">
                             <div className="col-span-4">路名</div>
                             <div className="col-span-2 text-center">寬(M)</div>
                             <div className="col-span-3">方位</div>
                             <div className="col-span-2 text-center">主要</div>
                             <div className="col-span-1"></div>
                          </div>
                          <div className="max-h-40 overflow-y-auto pr-1 space-y-2">
                             {inputs.roads.map(r => (
                               <div key={r.id} className="grid grid-cols-12 gap-2 items-center bg-stone-50 p-2 rounded border border-stone-100">
                                  <div className="col-span-4"><input type="text" value={r.name} onChange={(e) => updateRoad(r.id, 'name', e.target.value)} className={`${inputClass} py-1 text-sm`} placeholder="路名"/></div>
                                  <div className="col-span-2"><input type="number" value={r.width} onChange={(e) => updateRoad(r.id, 'width', e.target.value)} className={`${inputClass} py-1 text-sm text-center`} placeholder="M"/></div>
                                  <div className="col-span-3">
                                     <select value={r.orientation} onChange={(e) => updateRoad(r.id, 'orientation', e.target.value)} className={`${inputClass} py-1 text-xs px-1`}>
                                        <option value="top">上方</option><option value="bottom">下方</option><option value="left">左側</option><option value="right">右側</option>
                                     </select>
                                  </div>
                                  <div className="col-span-2 flex justify-center"><input type="checkbox" checked={r.type === 'primary'} onChange={(e) => updateRoad(r.id, 'type', e.target.checked ? 'primary' : 'secondary')} className="w-4 h-4 rounded border-stone-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer"/></div>
                                  <div className="col-span-1 text-center">{inputs.roads.length > 1 && <button onClick={() => removeRoad(r.id)} className="text-stone-300 hover:text-rose-500"><Trash2 size={14} /></button>}</div>
                               </div>
                             ))}
                          </div>
                       </div>
                    </div>

                    <div className="mt-4 pt-4 border-t border-stone-100">
                        <div className="flex justify-between items-center mb-2">
                           <h4 className="text-xs font-bold text-stone-500 uppercase flex items-center gap-1"><Ruler size={12} /> 基地形狀設定 (3D)</h4>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                           <div>
                              <label className="text-[10px] text-stone-400 block">面寬 (Width)</label>
                              <input type="number" value={inputs.baseWidth || Math.sqrt(totalBaseArea || 100).toFixed(1)} onChange={(e) => updateBaseDim('baseWidth', e.target.value)} className="w-full border border-stone-200 rounded p-1 text-sm font-bold text-stone-700 bg-stone-50 focus:bg-white focus:ring-2 ring-indigo-100 outline-none num-font" />
                           </div>
                           <div>
                              <label className="text-[10px] text-stone-400 block">深度 (Depth)</label>
                              <input type="number" value={((totalBaseArea || 100) / (parseFloat(inputs.baseWidth) || Math.sqrt(totalBaseArea || 100))).toFixed(1)} onChange={(e) => {
                                 const val = parseFloat(e.target.value);
                                 if (val > 0 && totalBaseArea > 0) updateBaseDim('baseWidth', (totalBaseArea/val).toFixed(2));
                              }} className="w-full border border-stone-200 rounded p-1 text-sm font-bold text-stone-700 bg-stone-50 focus:bg-white focus:ring-2 ring-indigo-100 outline-none num-font" />
                           </div>
                        </div>
                    </div>
                  </div>
                </CollapsibleSection>

                <CollapsibleSection title="法規參數" icon={<FileText size={18} className="text-sky-500" />} className="xl:col-span-1">
                  <div className="space-y-3">
                    <div><label className={labelClass}>使用分區</label><input type="text" name="zoneType" value={inputs.zoneType} onChange={handleInputChange} className={inputClass} /></div>
                    <div><label className={labelClass}>都市計畫名稱</label><input type="text" name="urbanPlanName" value={inputs.urbanPlanName} onChange={handleInputChange} className={inputClass} /></div>
                    <div className="grid grid-cols-2 gap-3">
                      <div><label className={`${labelClass} text-sky-600`}>建蔽率 (%)</label><input type="number" name="coverageRatio" value={inputs.coverageRatio} onChange={handleInputChange} className={`${inputClass} font-bold text-sky-700`} /></div>
                      <div><label className={`${labelClass} text-sky-600`}>容積率 (%)</label><input type="number" name="floorRatio" value={inputs.floorRatio} onChange={handleInputChange} className={`${inputClass} font-bold text-sky-700`} /></div>
                    </div>
                    <div><label className={`${labelClass} text-amber-600`}>地下室開挖率 (%)</label><input type="number" name="excavationRatio" value={inputs.excavationRatio} onChange={handleInputChange} className={`${inputClass} text-amber-700`} /></div>
                  </div>
                </CollapsibleSection>

                <CollapsibleSection title="樓層規劃" icon={<Layers size={18} className="text-indigo-500" />} className="xl:col-span-1">
                  <div className="space-y-3">
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className={labelClass}>地上樓層數 (預估)</label>
                        <div className={`${inputClass} bg-stone-50 font-bold text-indigo-600 flex items-center justify-between`}>
                           <span>{finalRes.floorsAbove}F</span>
                           <span className="text-xs text-stone-400 font-normal">(C8/A2={formatNum(finalRes.calculatedFloors)})</span>
                        </div>
                      </div>
                      <div><label className={labelClass}>地下樓層數</label><input type="number" name="floorsBelow" value={inputs.floorsBelow} onChange={handleInputChange} className={inputClass} /></div>
                    </div>
                    <div>
                       <label className={labelClass}>允建總樓地板面積 (Total CFA)</label>
                       <div className={`${inputClass} bg-stone-50 text-xl font-bold text-right flex items-center justify-between text-indigo-800`}>
                          <span className="text-xs text-indigo-300 font-normal">Auto Calc</span>
                          {formatNum(finalRes.totalCFA)}
                       </div>
                    </div>
                  </div>
                </CollapsibleSection>
              </div>

              <div className="bg-white rounded-xl shadow-sm overflow-hidden border border-stone-200">
                <div className="p-4 bg-stone-100 border-b border-stone-200 flex justify-between items-center cursor-pointer hover:bg-stone-100 transition-colors" onClick={() => setShowDetail(!showDetail)}>
                   <h3 className="font-bold text-stone-700 flex items-center gap-2"><FileText size={18} /> 詳細計算表</h3>
                   <div className="text-stone-500">{showDetail ? <ChevronUp size={20} /> : <ChevronDown size={20} />}</div>
                </div>
                <div className={`transition-all duration-500 ease-in-out overflow-hidden ${showDetail ? 'max-h-[2500px] opacity-100' : 'max-h-0 opacity-0'}`}>
                   <div className="overflow-x-auto">
                      <table className="w-full text-left border-collapse num-font">
                         <thead>
                            <tr className="bg-stone-50 text-stone-600 text-sm border-b border-stone-300">
                               <th className="p-4 w-1/4">評估項目</th>
                               <th className="p-4 w-1/6 text-right">數值/面積 (㎡)</th>
                               <th className="p-4 w-1/6 text-right">坪數 (坪)</th>
                               {isEditMode && <><th className="p-4 text-indigo-700 bg-indigo-50/50 w-1/4">參數設定</th><th className="p-4 text-indigo-700 bg-indigo-50/50">註解與說明</th></>}
                            </tr>
                         </thead>
                         <tbody className="text-stone-700 divide-y divide-stone-100">
                            <SectionHeader title="A. 基地基礎法規檢討" />
                            <InputRow id="base" label="1. 基地面積" value={finalRes.base} calculatedValue={results.base} formula="SUM(地號面積)" note="多筆地號加總" isEditMode={isEditMode} onOverride={handleOverride} />
                            <InputRow id="maxBuildingArea" label="2. 允建建築面積" value={finalRes.maxBuildingArea} calculatedValue={results.maxBuildingArea} formula="基地面積 × 法定建蔽率" note={`建蔽率 ${inputs.coverageRatio}%，單層最大面積`} isEditMode={isEditMode} onOverride={handleOverride} highlight />
                            <InputRow id="statutoryFA" label="3. 法定容積 (FA)" value={finalRes.statutoryFA} calculatedValue={results.statutoryFA} formula="基地面積 × 法定容積率" note={`容積率 ${inputs.floorRatio}%，不含獎勵`} isEditMode={isEditMode} onOverride={handleOverride} highlight />
                            
                            <SectionHeader title="B. 免計容積與獎勵試算" />
                            <InputRow id="incentiveArea" label="4. 獎勵容積" value={inputs.incentiveArea} calculatedValue={inputs.incentiveArea} formula="自行輸入" note="都更、危老等獎勵" isEditMode={isEditMode} onOverride={handleInputChange} />
                            <InputRow id="transferArea" label="5. 移轉容積" value={inputs.transferArea} calculatedValue={inputs.transferArea} formula="自行輸入" note="容積移轉" isEditMode={isEditMode} onOverride={handleInputChange} />
                            <InputRow id="exempt15" label={`6. 免計容積 (${params.exemptRate}%)`} value={finalRes.exempt15} calculatedValue={results.exempt15} formula="法定容積 FA × 免計率" note="機電設備、安全梯等 (法規上限)" isEditMode={isEditMode} onOverride={handleOverride} paramKey="exemptRate" paramValue={params.exemptRate} onParamChange={handleParamChange} />
                            <InputRow id="exemptStair" label="7. 免計梯廳" value={finalRes.exemptStair} calculatedValue={results.exemptStair} formula={`法定容積 FA × ${params.stairRate}%`} note="梯廳獎勵，需視設計而定" isEditMode={isEditMode} onOverride={handleOverride} paramKey="stairRate" paramValue={params.stairRate} onParamChange={handleParamChange} />
                            <InputRow id="exemptIndoor" label="8. 免計容積室內合計" value={finalRes.exemptIndoor} calculatedValue={results.exemptIndoor} formula="Item 6 + Item 7" note="免計容積總和" isEditMode={isEditMode} onOverride={handleOverride} subTotal />
                            <InputRow id="balcony" label="9. 免計容積陽台" value={finalRes.balcony} calculatedValue={results.balcony} formula={`法定容積 FA × ${params.balconyRate}%`} note="每層樓地板 1/8 或 FA 10%" isEditMode={isEditMode} onOverride={handleOverride} paramKey="balconyRate" paramValue={params.balconyRate} onParamChange={handleParamChange} />
                            
                            <SectionHeader title="C. 允建面積總表" />
                            <InputRow id="permittedIndoor" label="10. 允建室內面積" value={finalRes.permittedIndoor} calculatedValue={results.permittedIndoor} formula="法定 + 獎勵 + 移轉 + 免計" note="不含陽台之室內實際使用空間" isEditMode={isEditMode} onOverride={handleOverride} bold />
                            <InputRow id="roofProtrusion" label="11. 允建屋突面積" value={finalRes.roofProtrusion} calculatedValue={results.roofProtrusion} formula="(建築面積 × 1/8) × 2層" note="屋頂突出物 (水箱、電梯機房)" isEditMode={isEditMode} onOverride={handleOverride} />
                            <InputRow id="totalBasementArea" label="12. 地下室總面積" value={finalRes.totalBasementArea} calculatedValue={results.totalBasementArea} formula="基地 × 開挖率 × 地下層數" note={`開挖率 ${inputs.excavationRatio}%，地下 ${inputs.floorsBelow} 層`} isEditMode={isEditMode} onOverride={handleOverride} />
                            
                            <tr className="bg-amber-50 border-y-2 border-amber-200">
                               <td className="p-4 font-bold text-stone-800 text-lg">13. 允建總樓地板面積 (Total CFA)</td>
                               <td className="p-4 text-right font-bold text-stone-800 text-lg">
                                  {isEditMode ? (
                                    <div className="flex items-center justify-end gap-2">
                                       {Math.abs(finalRes.totalCFA - results.totalCFA) > 0.01 && <div className="text-red-500 flex items-center text-xs" title="與公式計算值衝突"><AlertTriangle size={14}/></div>}
                                       <input type="number" value={finalRes.totalCFA} onChange={(e) => handleOverride('totalCFA', e.target.value)} className="w-24 p-1 text-right border border-stone-300 rounded bg-white"/>
                                    </div>
                                  ) : formatNum(finalRes.totalCFA)}
                               </td>
                               <td className="p-4 text-right font-bold text-stone-800 text-lg">{formatNum(toPing(finalRes.totalCFA))}</td>
                               {isEditMode && <><td className="p-4 font-mono text-xs text-stone-600">允建室內+陽台+屋突+地下室</td><td className="p-4 text-sm text-stone-600">全棟可蓋總面積 (含車位空間)</td></>}
                            </tr>
                            <tr className="bg-stone-100 border-y-2 border-stone-200">
                               <td className="p-4 font-bold text-stone-700 text-lg">工程預算評估</td>
                               <td className="p-4 text-right font-bold text-stone-700 text-lg" colSpan={2}>
                                  <div className="flex items-center justify-end gap-2">
                                     <span className="text-sm text-stone-500 font-normal mr-2">單價(萬/坪):</span>
                                     {isEditMode ? <input type="number" value={params.pricePerPing} onChange={(e) => handleParamChange('pricePerPing', e.target.value)} className="w-20 p-1 text-right border border-stone-300 rounded bg-white font-bold"/> : <span className="font-bold underline decoration-dotted decoration-stone-400">{params.pricePerPing}</span>}
                                     <span className="text-sm text-stone-500 mx-2">=</span>
                                     <span>{formatNum(finalRes.estimatedBudget)} 萬</span>
                                  </div>
                               </td>
                               {isEditMode && <><td className="p-4 font-mono text-xs text-stone-500">Total CFA (坪) × 單價</td><td className="p-4 text-sm text-stone-500">概估造價 (未含設計監造/稅)</td></>}
                            </tr>

                            <SectionHeader title="D. 空間與停車檢討" />
                            <tr className="hover:bg-stone-50">
                               <td className="p-4 pl-8 border-l-4 border-stone-300 font-medium">12. 地上樓層估算</td>
                               <td className="p-4 text-right" colSpan={2}>約 <span className="font-bold text-indigo-600">{formatNum(finalRes.floorsAbove)}</span> 層</td>
                               {isEditMode && <><td className="p-4 font-mono text-xs text-stone-500">C8 / A2</td><td className="p-4 text-sm text-stone-500">允建室內 / 允建建築面積</td></>}
                            </tr>
                            <tr className="hover:bg-stone-50">
                               <td className="p-4 pl-8 border-l-4 border-stone-300 font-medium">13. 地下層開挖檢討</td>
                               <td className="p-4 text-right" colSpan={2}>B1 ~ B{inputs.floorsBelow} (單層 {formatNum(toPing(finalRes.basementAreaPerFloor))} 坪)</td>
                               {isEditMode && <><td className="p-4 font-mono text-xs text-stone-500">基地 × {inputs.excavationRatio}%</td><td className="p-4 text-sm text-stone-500">單層最大開挖面積</td></>}
                            </tr>
                            <tr className="hover:bg-stone-50">
                               <td className="p-4 pl-8 border-l-4 border-stone-300 font-medium flex items-center gap-2"><Car size={16}/> 14. 停車空間檢討</td>
                               <td className="p-4 text-right" colSpan={2}>法定約 {formatNum(finalRes.statutoryParking)} 部 / 空間可停 {formatNum(finalRes.possibleParking)} 部</td>
                               {isEditMode && <><td className="p-4 font-mono text-xs text-stone-500">總樓地板/150 (法定)</td><td className="p-4 text-sm text-stone-500">空間以每車 {inputs.avgCarArea}m² 預估</td></>}
                            </tr>
                            <tr className="hover:bg-stone-50">
                               <td className="p-4 pl-8 border-l-4 border-stone-300 font-medium">15. 坪效分析 (倍數)</td>
                               <td className="p-4 text-right font-bold text-emerald-600" colSpan={2}>{formatNum(finalRes.efficiency)} 倍</td>
                               {isEditMode && <><td className="p-4 font-mono text-xs text-stone-500">總銷坪 / 基地坪</td><td className="p-4 text-sm text-stone-500">投入 1 坪土地可蓋出的坪數</td></>}
                            </tr>

                            <SectionHeader title="E. 高度比檢討" />
                            <tr className="hover:bg-stone-50">
                               <td className="p-4 pl-8 border-l-4 border-stone-300 font-medium">16. 前院深度</td>
                               <td className="p-4 text-right"><div className="flex items-center justify-end gap-2"><input type="number" name="frontYardDepth" value={inputs.frontYardDepth} onChange={handleInputChange} className="w-20 p-1 text-right border border-stone-300 rounded"/> m</div></td>
                               <td className="p-4 text-right text-stone-500"></td>
                               {isEditMode && <><td className="p-4 font-mono text-xs text-stone-500">自行輸入</td><td className="p-4 text-sm text-stone-500">3D圖面顯示退縮</td></>}
                            </tr>
                            <tr className="hover:bg-stone-50">
                               <td className="p-4 pl-8 border-l-4 border-stone-300 font-medium">17. 側院深度</td>
                               <td className="p-4 text-right"><div className="flex items-center justify-end gap-2"><select name="sideYardDirection" value={inputs.sideYardDirection} onChange={handleInputChange} className="p-1 border border-stone-300 rounded text-xs bg-stone-50"><option value="right">右側</option><option value="left">左側</option></select><input type="number" name="sideYardDepth" value={inputs.sideYardDepth} onChange={handleInputChange} className="w-20 p-1 text-right border border-stone-300 rounded"/> m</div></td>
                               <td className="p-4 text-right text-stone-500"></td>
                               {isEditMode && <><td className="p-4 font-mono text-xs text-stone-500">選單邊</td><td className="p-4 text-sm text-stone-500">3D圖面顯示退縮</td></>}
                            </tr>
                            <tr className="hover:bg-stone-50">
                               <td className="p-4 pl-8 border-l-4 border-stone-300 font-medium">18. 後院深度</td>
                               <td className="p-4 text-right"><div className="flex items-center justify-end gap-2"><input type="number" name="backYardDepth" value={inputs.backYardDepth} onChange={handleInputChange} className="w-20 p-1 text-right border border-stone-300 rounded"/> m</div></td>
                               <td className="p-4 text-right text-stone-500"></td>
                               {isEditMode && <><td className="p-4 font-mono text-xs text-stone-500">自行輸入</td><td className="p-4 text-sm text-stone-500">3D圖面顯示退縮</td></>}
                            </tr>
                            <tr className="hover:bg-stone-50">
                               <td className="p-4 pl-8 border-l-4 border-stone-300 font-medium">*最小後院深度比</td>
                               <td className="p-4 text-right"><div className="flex items-center justify-end gap-2"><input type="number" name="minBackyardDepthRatio" value={inputs.minBackyardDepthRatio || 0} onChange={handleInputChange} className="w-20 p-1 text-right border border-stone-300 rounded"/> <span className="text-xs text-stone-400">H/D</span></div></td>
                               <td className="p-4 text-right text-stone-500"></td>
                               {isEditMode && <><td className="p-4 font-mono text-xs text-stone-500">檢討用</td><td className="p-4 text-sm text-stone-500">決定後院比斜率</td></>}
                            </tr>
                            <tr className="hover:bg-stone-50">
                               <td className="p-4 pl-8 border-l-4 border-stone-300 font-medium">19. 樓層高度設定</td>
                               <td className="p-4 text-right" colSpan={2}>
                                  <div className="flex flex-col gap-2 items-end">
                                     <div className="flex items-center gap-2"><span className="text-xs text-stone-500">1F:</span><input type="number" name="floorHeight1F" value={inputs.floorHeight1F} onChange={handleInputChange} className={`w-16 p-1 text-right border rounded ${inputs.zoneType === '住宅區' && parseFloat(inputs.floorHeight1F) > 4.2 ? 'border-rose-400 bg-rose-50' : 'border-stone-300'}`}/></div>
                                     <div className="flex items-center gap-2"><span className="text-xs text-stone-500">其他:</span><input type="number" name="floorHeightOther" value={inputs.floorHeightOther} onChange={handleInputChange} className={`w-16 p-1 text-right border rounded ${inputs.zoneType === '住宅區' && parseFloat(inputs.floorHeightOther) > 3.6 ? 'border-rose-400 bg-rose-50' : 'border-stone-300'}`}/></div>
                                  </div>
                               </td>
                               {isEditMode && <><td className="p-4 font-mono text-xs text-stone-500">住宅區 1F≤4.2, 其他≤3.6</td><td className="p-4 text-sm text-stone-500">自行輸入 (超限變紅)</td></>}
                            </tr>
                            <InputRow id="buildingHeight" label="20. 建築物高度" value={finalRes.buildingHeight} calculatedValue={finalRes.buildingHeight} formula="1F+(其他×(F-1))+9" note={finalRes.isSuperHighRise ? "超高層建築 (>100m)" : finalRes.isHighRise ? "高層建築 (>24m)" : "一般建築"} isEditMode={isEditMode} onOverride={handleOverride} highlight />
                            <InputRow id="heightRatio" label="21. 高度比" value={finalRes.heightRatio} calculatedValue={finalRes.heightRatio} formula="高度 / (路寬+前院)" note="建築高度 / (主路寬+前院深)" isEditMode={isEditMode} onOverride={handleOverride} highlight />
                            <InputRow id="backyardDepthRatio" label="22. 後院深度比" value={finalRes.backyardDepthRatio} calculatedValue={finalRes.backyardDepthRatio} formula="高度 / 後院深" note="建築高度 / 後院深" isEditMode={isEditMode} onOverride={handleOverride} highlight />
                            <InputRow id="weiLaoRatio" label="23. 危老評估 (路心比)" value={finalRes.weiLaoRatio} calculatedValue={finalRes.weiLaoRatio} formula="5 / (0.5×路寬 + 前院)" note="危老條例高度檢討係數" isEditMode={isEditMode} onOverride={handleOverride} highlight />
                         </tbody>
                      </table>
                   </div>
                </div>
              </div>

            </div>
          </div>
        );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<Cal />);
    </script>
  </body>
</html>